# 支付宝支付集成完整指南

本指南将帮助你一步步配置真实的支付宝支付系统。

---

## 📋 前置要求

- 企业支付宝账号（个人账号无法开通）
- 营业执照（企业认证需要）
- 服务器（用于接收支付回调）

---

## 🚀 第一步：注册支付宝开放平台账号

### 1.1 访问支付宝开放平台

1. 访问：https://open.alipay.com/
2. 点击右上角"注册"或"登录"
3. 使用企业支付宝账号登录（如果没有，需要先注册企业支付宝）

### 1.2 完成企业认证

1. 登录后，进入"控制台"
2. 如果未认证，点击"立即认证"
3. 上传营业执照
4. 填写企业信息
5. 等待审核（通常 1-3 个工作日）

---

## 🔧 第二步：创建应用

### 2.1 创建网页&移动应用

1. 登录支付宝开放平台控制台
2. 点击左侧菜单"网页&移动应用"
3. 点击"创建应用"
4. 选择"网页&移动应用"
5. 填写应用信息：
   - **应用名称**：橙龙科技会员系统（或你的应用名称）
   - **应用类型**：网页应用
   - **应用描述**：会员订阅支付系统
6. 点击"创建"

### 2.2 配置应用信息

创建应用后，需要配置：

1. **应用网关**：
   ```
   https://your-domain.com/api/membership/alipay/notify
   ```
   （替换为你的实际域名）

2. **授权回调地址**：
   ```
   https://your-domain.com/membership/success
   ```
   （替换为你的实际域名）

3. **接口权限**：
   - 找到"电脑网站支付"接口
   - 点击"申请"
   - 填写申请理由
   - 等待审核通过

---

## 🔑 第三步：配置密钥

### 3.1 生成 RSA2 密钥对

#### 方法一：使用 OpenSSL（推荐）

```bash
# 生成私钥（2048位）
openssl genrsa -out rsa_private_key.pem 2048

# 生成公钥
openssl rsa -in rsa_private_key.pem -pubout -out rsa_public_key.pem
```

#### 方法二：使用在线工具

1. 访问：https://opendocs.alipay.com/common/02kkv7
2. 下载密钥生成工具
3. 生成密钥对

### 3.2 上传公钥到支付宝

1. 在支付宝开放平台控制台
2. 进入"应用信息" → "开发信息"
3. 找到"接口加签方式"
4. 点击"设置"
5. 选择"公钥"
6. 复制 `rsa_public_key.pem` 的内容（不包含 BEGIN/END 行）
7. 粘贴到支付宝
8. 点击"保存"

### 3.3 获取支付宝公钥

1. 在"接口加签方式"页面
2. 点击"查看支付宝公钥"
3. 复制支付宝公钥（用于验证回调签名）

---

## ⚙️ 第四步：配置环境变量

### 4.1 获取应用信息

在支付宝开放平台控制台：

1. **APPID**：在"应用信息"页面可以看到
2. **应用私钥**：你刚才生成的 `rsa_private_key.pem` 文件内容
3. **支付宝公钥**：从"接口加签方式"页面获取

### 4.2 配置环境变量

在项目根目录的 `.env.local` 文件中添加：

```env
# 支付宝配置
ALIPAY_APP_ID=你的APPID
ALIPAY_PRIVATE_KEY=你的应用私钥（完整内容，包括BEGIN和END行）
ALIPAY_PUBLIC_KEY=支付宝公钥（完整内容，包括BEGIN和END行）
ALIPAY_GATEWAY=https://openapi.alipay.com/gateway.do

# 网站基础 URL（用于支付回调）
NEXT_PUBLIC_BASE_URL=https://your-domain.com
```

**重要提示**：
- 私钥格式示例：
  ```
  ALIPAY_PRIVATE_KEY="-----BEGIN RSA PRIVATE KEY-----
  MIIEpAIBAAKCAQEA...
  ...
  -----END RSA PRIVATE KEY-----"
  ```
- 公钥格式示例：
  ```
  ALIPAY_PUBLIC_KEY="-----BEGIN PUBLIC KEY-----
  MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8A...
  ...
  -----END PUBLIC KEY-----"
  ```

### 4.3 沙箱环境配置（测试用）

如果是测试环境，使用沙箱配置：

```env
ALIPAY_GATEWAY=https://openapi.alipaydev.com/gateway.do
```

沙箱账号可以在支付宝开放平台 → "开发助手" → "沙箱环境" 获取。

---

## 🧪 第五步：测试支付流程

### 5.1 本地测试

1. 启动开发服务器：
   ```bash
   npm run dev
   ```

2. 访问：http://localhost:3000/membership

3. 选择订阅计划

4. 点击"立即订阅"

5. 在支付页面点击"确认支付"

6. 应该会跳转到支付宝支付页面

### 5.2 使用沙箱账号测试

1. 在支付宝开放平台获取沙箱账号
2. 使用沙箱买家账号登录支付宝
3. 完成支付测试

### 5.3 验证支付回调

支付成功后：
1. 支付宝会跳转回 `returnUrl`（支付成功页面）
2. 支付宝会异步通知 `notifyUrl`（支付回调接口）
3. 检查订单状态是否更新为"已支付"
4. 检查用户会员状态是否更新

---

## 📝 第六步：生产环境部署

### 6.1 配置生产环境变量

在 Vercel（或其他部署平台）添加环境变量：

1. **ALIPAY_APP_ID**：你的 APPID
2. **ALIPAY_PRIVATE_KEY**：你的应用私钥
3. **ALIPAY_PUBLIC_KEY**：支付宝公钥
4. **ALIPAY_GATEWAY**：`https://openapi.alipay.com/gateway.do`
5. **NEXT_PUBLIC_BASE_URL**：你的生产环境域名（如 `https://your-domain.com`）

### 6.2 配置支付回调地址

在支付宝开放平台：

1. 进入应用设置
2. 设置"应用网关"为：
   ```
   https://your-domain.com/api/membership/alipay/notify
   ```
3. 确保回调地址可以从公网访问（Vercel 会自动处理）

### 6.3 测试生产环境

1. 部署代码到生产环境
2. 使用真实支付宝账号测试支付
3. 验证支付回调是否正常
4. 检查订单和会员状态更新

---

## 🔍 常见问题

### Q1: 如何查看支付日志？

- 支付宝开放平台 → "交易中心" → "交易查询"
- 可以查看所有交易记录

### Q2: 支付回调没有收到怎么办？

1. 检查回调地址是否正确配置
2. 检查服务器是否可以从公网访问
3. 查看支付宝开放平台的"交易中心" → "异步通知查询"
4. 检查服务器日志

### Q3: 签名验证失败？

1. 检查私钥和公钥是否正确配置
2. 确保密钥格式正确（包含 BEGIN/END 行）
3. 检查环境变量是否正确加载

### Q4: 如何切换沙箱和生产环境？

修改 `ALIPAY_GATEWAY` 环境变量：
- 沙箱：`https://openapi.alipaydev.com/gateway.do`
- 生产：`https://openapi.alipay.com/gateway.do`

### Q5: 支付成功后没有更新会员状态？

1. 检查支付回调接口是否正常
2. 查看服务器日志
3. 检查数据库连接
4. 验证订单号是否正确

---

## 📚 相关文档

- [支付宝开放平台](https://open.alipay.com/)
- [电脑网站支付文档](https://opendocs.alipay.com/open/270/105898)
- [密钥生成工具](https://opendocs.alipay.com/common/02kkv7)
- [沙箱环境](https://open.alipay.com/develop/sandbox/app)

---

## ✅ 配置检查清单

完成以下步骤后，你的支付宝支付就配置好了：

- [ ] 注册支付宝开放平台账号
- [ ] 完成企业认证
- [ ] 创建应用
- [ ] 申请"电脑网站支付"接口权限
- [ ] 生成 RSA2 密钥对
- [ ] 上传公钥到支付宝
- [ ] 获取支付宝公钥
- [ ] 配置环境变量（APPID、私钥、公钥）
- [ ] 配置应用网关和回调地址
- [ ] 测试支付流程
- [ ] 部署到生产环境
- [ ] 配置生产环境变量
- [ ] 测试生产环境支付

---

## 🆘 需要帮助？

如果遇到问题：
1. 查看支付宝开放平台的"开发文档"
2. 联系支付宝技术支持
3. 检查服务器日志
4. 查看本文档的"常见问题"部分

---

**配置完成后，你的会员订阅系统就可以使用真实的支付宝支付了！** 🎉

